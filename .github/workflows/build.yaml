---
name: Build
"on":
  push:
  pull_request:

jobs:

  build:
    name: Build, check and publish package on release
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2.4.0
      - uses: actions/setup-python@v2.2.2
      - name: Build package
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade poetry
          poetry install --no-interaction --no-ansi
          poetry build --no-interaction --no-ansi
      - name: Attach packages to workflow run for later inspection and debugging
        uses: actions/upload-artifact@v2.2.4
        with:
          name: mpm-python-packages
          path: ./dist/*
      - name: Validates package metadata
        run: |
          poetry check --no-interaction --no-ansi
          poetry run twine check ./dist/*
          poetry run check-wheel-contents ./dist/*.whl
      - name: Test publishing
        run: |
          poetry publish --dry-run --no-interaction
      - name: Extract tag version
        id: get_version
        # Docs: https://docs.github.com/en/actions/learn-github-actions
        # /workflow-commands-for-github-actions#setting-an-output-parameter
        run: |
          echo ::set-output name=TAG_VERSION::${GITHUB_REF#refs/tags/v}
          echo "Tag version: ${{ steps.get_version.outputs.TAG_VERSION }}"
      # Steps below only triggers on version tagging (but the most innocuous).
      - name: Create a release on GitHub
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ./dist/*
          body: |
            [üêç Available on PyPi
            ](https://pypi.org/project/meta-package-manager/${{
            steps.get_version.outputs.TAG_VERSION }}/)
      - name: Push package to public PyPi repository
        if: startsWith(github.ref, 'refs/tags/v')
        uses: pypa/gh-action-pypi-publish@v1.4.2
        with:
          user: __token__
          password: ${{ secrets.PYPI_TOKEN }}
      - name: Add new changelog entry
        run: |
          python ./.github/update_changelog.py
      - name: Version bump
        run: |
          poetry run bumpversion --verbose patch
      - uses: peter-evans/create-pull-request@v3.11.0
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          author: "Kevin Deldycke <kevin@deldycke.com>"
          commit-message: "[autofix] Post-release version bump"
          title: "[autofix] Post-release version bump"
          body: >
            [Auto-generated on run
            #${{ github.run_id }}](https://github.com/${{ github.repository
            }}/actions/runs/${{ github.run_id }}) as defined by [workflow
            action](https://github.com/${{ github.repository
            }}/blob/${{ github.base_ref }}/.github/workflows/build.yaml).
          labels: "üî© CI/CD, üìó documentation"
          assignees: kdeldycke
          base: main
          branch: version-bump
