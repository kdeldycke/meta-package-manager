---
name: Labels
"on":
  # Only the main branch has authority on the project management. This will
  # prevent any other tagging or release activity interfer with the project.
  push:
    branches:
      - main

jobs:

  labels:
    name: Generate and sync labels
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2.4.0
      - uses: actions/setup-python@v2.3.0
        with:
          # XXX Force Python 3.9 to not have 3.10 as default.
          # Waiting for boltons > 21.0.0 to be released with upstreamed
          # Python 3.10 fix: https://github.com/mahmoud/boltons/issues/294
          python-version: "3.9"
      - name: Install mpm
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade poetry
          poetry install --no-interaction --no-ansi
      - name: Generate labels
        run: |
          poetry run python ./.github/generate_labels.py
      - name: Discard all local changes but the label definitions file
        run: |
          # Remove untracked directories and files.
          git clean -fd
          # Temporarily stash our target file.
          git stash -- ./.github/labels.json
          # Reset all repository.
          git checkout --force
          # Restore modified file. Do not fail if no file has been stashed.
          git stash pop || true
      - uses: peter-evans/create-pull-request@v3.11.0
        with:
          author: "Kevin Deldycke <kevin@deldycke.com>"
          commit-message: "[github] Update project labels."
          title: '[github] Update project labels'
          body: >
            [Auto-generated on run
            #${{ github.run_id }}](https://github.com/${{ github.repository
            }}/actions/runs/${{ github.run_id }}) as defined by [workflow
            action](https://github.com/${{ github.repository
            }}/blob/${{ github.base_ref }}/.github/workflows/labels.yaml).
          labels: "ðŸ”© CI/CD"
          assignees: kdeldycke
          branch: update-labels
      - name: Sync labels
        uses: lannonbr/issue-label-manager-action@3.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
